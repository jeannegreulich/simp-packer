## SIMP Packer manifests

#### Table of Contents

* [Overview](#overview)
* [Setup](#setup)
* [Usage](#usage)
* [Simple build](#simple-build)
* [Notes](#notes)
* [TODO](#todo)
* [DONE](#done)

### Overview

[Packer](https://packer.io) configuration to build a [Vagrant](https://www.vagrantup.com/) box directly from a fresh [SIMP](https://github.com/NationalSecurityAgency/SIMP) ISO and run some basic tests that need a full puppet install to verify.   SIMP 6 and later ISOs can be tested.

### Setup

Requirements:
  - [VirtualBox](https://www.virtualbox.org/wiki/Downloads)
  - [Vagrant](https://www.vagrantup.com/downloads.html)
  - SIMP ISO created from build:auto and its json file.
  - packer installed in or linked to /bin/packer. (There is
    another command called packer in /usr/sbin/packer so I
    point specifically to /bin/packer.)

### Usage
#### Simple build
1\. To define a test, create a test directory and include the following three files:
      vars.json:  The json file from the SIMP ISO.  If you have moved the iso
           make sure it points to the location of the SIMP ISO you want to test.
      simp_conf.yaml:  A simp_conf.yaml file with the setup you want to test.  These
         are generated by running simp config on a machine.  You can get a copy of
         one from a previous run or edit one from the samples files.
      packer.yaml:  You have to have this file but it will default everything.
         look in simp_config.rb for the default settings.

NOTE:  The puppet server info and fips info is all changed by the defaults or the
packer.yaml settings.

Assumptions at this time:
  - You must have the virtual box network set up before starting.  It must be class C
    and the router must be IP Address X.X.X.1
    See the Virtual Box section at the bottom for some help.
  - The puppet server will be set up to be X.X.X.7
  - DHCP and DNS are set up to contain server21.domain.name - server29.domain.name
    and ws30.domain.name - ws39.domain.name.
    The machine server21 will have IP X.X.X.21 and mac address of XXXXXXXXXX21
    and so on.
  - The default passwords for everything (users, LDAP) is P@ssw0rdP@ssw0rd.
    You change it in vars.json with new_password.
  - Changing the LDAP Password doesn't work at this time.
  - It only works for systems with LDAP set up.  It will change
    the basedn to match what you have in packer.yaml for DOMAIN or use
    the default.  It sets up user1, user2, admin1, admin2.
  - The distribution DVD is looked for in the /net/ISO/Distribution_ISOs directory.
    It is hard coded in simp.json.template right now.


You don't have to set anything in the packer.yaml file on CentOS 7.  For CentOS 6
you need to change the NAT_INTERFACE and HOST_ONLY_INTERFACE to eth0 and eth1 
respectively.


2\. Run the test: Run the script:
     TMPDIR=<some directory with lots of space> simp-packer_test.sh <full path to test directory from #1>

Packer use TMPDIR variable for it temporary directory and it needs something like twice the space of the virtual machine so /tmp won't work.  

It will run and create a working diretory under the test directory where all the scripts,manifests and files are kept.  This is deleted at the end.
A time stamed log file is created in the top level of the test directory and all the output from packer is copied here.  If the packer build fails, this is renamed from <date>.log to <date>.log.errors. 

3\. I don't have all the test working at this time.

packer installs the iso, then packer uses the simp.json file to step it through
configuring simp according to the simp_conf.yaml and running simp bootstrap.
This is done in the build section and the start of the provisioning section.

Once the setup is complete, the tests are run.  These are the final sections in the
provisioning section of the simp.json.template.  Currently
it tests the following:
1) That the build of the puppet server is successful.
2) Puppet server is up and running and listening on the ports configured in simp_conf.yaml
3) It verifies that FIPS is setting match across the simp_conf.yaml, the simp_def.yaml and
   in the operational environment.
4) Checks that selinux matches the simp_conf.yaml selinux::secure setting.
5) If simp_crypt_disk is used in the simp.conf, it verifies that the disk is encrypted.
6) Verifies that /, /var/,/var/audit are separate partitions.

Default output directory is <test directory>/OUTPUT.

The output will be put in the output directory in a time stamped directory.  Packer fails if the output directory exists for some reason.

I put a Vagrant file in the output directory that can used to bring up the vagrant box.
I couldn't put it in the time stamp directory because... packer fails if the output directory exists and I don't have the output directory in the shell script.  (TODO... fix that.)

I also didn't copy it into the vagrant box, so you could see the settings in order to make sure you have the correct network set up where ever you are running it. (or change host only network name to a network you have configured for that address.  By deault it will not change the hostname or ip address of the machine because we all know how much fun that is to update.  (I have not tested changing the host_only network name.  My machines are all set up to match the defaults (go figure)

-note I am thinking of putting the data in the name of the box because if you have used the box already with that name, it copies it local and doesn't update it even if check fo rupdates is true.

-The vagrant password is vagrant.

### Virtual Box management notes:

This just gives some quick steps for checking your networks and configuring them

To list your hostonly networks:

   VBoxManage list hostonlyifs

When you create a new hostonly network it creates them in order, so vboxnet0, then vboxnet1 ...etc

To create a new network:
   VBoxManage hostonlyif create
(It will tell you what network it created.)

To update the address of the network:

   VBoxManage hostonlyif ipconfig <networkname>  --ip <network address>

So to make vboxnet1 set to 192.168.101.1 (that being the router address.)
   VBoxManage hostonlyif ipconfig vboxnet1 --ip 192.168.101.1


### TODO
- test if master is yum that yum is set up and working.

