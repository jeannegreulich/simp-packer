## SIMP Packer manifests

#### Table of Contents

* [Overview](#overview)
* [Setup](#setup)
* [Usage](#usage)
* [Simple build](#simple-build)
* [Notes](#notes)
* [TODO](#todo)
* [DONE](#done)

### Overview

[Packer](https://packer.io) configuration to build a [Vagrant](https://www.vagrantup.com/) box directly from a fresh [SIMP](https://github.com/NationalSecurityAgency/SIMP) ISO and run some basic tests that need a full puppet install to verify.   SIMP 6 and later ISOs can be tested.

### Setup

Requirements:
  - [VirtualBox](https://www.virtualbox.org/wiki/Downloads)
  - [Vagrant](https://www.vagrantup.com/downloads.html)
  - SIMP ISO created from build:auto and its json file.
    These contain the json variables that point to the iso,
    the iso checksum and the name of the distribution iso.
  - packer installed in or linked to /bin/packer. (There is
    another command called packer in /usr/sbin/packer so I
    point specifically to /bin/packer.)

### Usage
#### Simple build
1\. To define a test, create a test directory and include the following three files
 (There is more information on these three files in the samples directory.):
      vars.json:  The json file from the SIMP ISO.  If you have moved the iso
           make sure it points to the location of the SIMP ISO you want to test.
      simp_conf.yaml:  A simp_conf.yaml file with the setup you want to test.  These
         are generated by running simp config on a machine.  You can get a copy of
         one from a previous run or edit one from the samples files.
      packer.yaml:  You have to have this file but it will default everything.
         look in simp_config.rb for the default settings.

NOTE:  The puppet server info and fips info in the simp_conf.yaml file is all
changed by the defaults or the packer.yaml settings.

Assumptions at this time:
  - The puppet server will be set up to be X.X.X.7
  - DHCP and DNS are set up to contain server21.domain.name - server29.domain.name
    and ws30.domain.name - ws39.domain.name.
    The machine server21 will have IP X.X.X.21 and mac address of XXXXXXXXXX21
    and so on.
  - The default passwords for everything (users, LDAP) is P@ssw0rdP@ssw0rd.
    You change it in vars.json with new_password.
  - Changing the LDAP Password doesn't work at this time.
  - It only works for systems with LDAP set up.  It will change
    the basedn to match what you have in packer.yaml for DOMAIN or use
    the default.  It sets up user1, user2, admin1, admin2.
  - The distribution DVD is looked for in the /net/ISO/Distribution_ISOs directory.
    It is hard coded in simp.json.template right now.


You don't have to set anything in the packer.yaml file on CentOS 7.  For CentOS 6
you need to change the NAT_INTERFACE and HOST_ONLY_INTERFACE to eth0 and eth1
respectively.


2\. Run the test: Run the script:
     TMPDIR=<some directory with lots of space> simp-packer_test.sh <full path to test directory from #1>

Packer use TMPDIR variable for it temporary directory and it needs something
like twice the space of the virtual machine so /tmp won't work.

It will run and create a working directory under the test directory where all the scripts,manifests and files are kept.
This is deleted at the end.  I did this so I could keep working and updating the files without having to worry about
messing with what was running.

A time stamped log file is created in the top level of the test directory and all the output from packer is copied here.
If the packer build fails, this is renamed from <date>.log to <date>.log.errors.

3\. OUTPUT: 
Log file:  Located in the test directory.  It will be time stamped.
Vagrant box with VagrantFile:  This will be located in the directory defined
   by the packer.yaml file OUTPUT_DIRECTORY (default is <testdirectory>/OUTPUT.
The artifacts are in a time stamped directory underneath but are deleted by default.

4\. Overview of what it does.

The build section installs the iso, adds the vagrant user, configures the network
to start up a boot time.  Changes the passwords for simp and root. 
Updates the sudo file so simp user can sudo without a password and without a tty.

The provisioning section:
- checks if fips was turned on that the system came up in fips.
- runs simp config and simp bootstrap.
- installs a manifest that will configure the vagrant user so you can 
  vagrant ssh once the box is built and configures simp user so packer
  can continue working.
- it reboots
- it runs puppet a couple of times
- it runs some more tests
    1) That the build of the puppet server is successful.
    2) Puppet server is up and running and listening on the ports configured in simp_conf.yaml
    3) It verifies that FIPS is setting match across the simp_conf.yaml, the simp_def.yaml and
       in the operational environment.
    4) Checks that selinux is set to enforcing (the default for simp.)
    5) If simp_crypt_disk is used in the simp.conf, it verifies that the disk is encrypted.
    6) Verifies that /, /var/,/var/audit are separate partitions.
    7) Checks that the port in puppet conf file matches the port in simp_conf.yaml
-if the tests pass it will configure the puppet server
   1) The simpsetup manifest is run via puppet apply.  It is run once
      so that if you make changes later on they are not over written.
       - setup the kickstart files
       - sets up dns
       - sets up tftp manifests
       -togen certificates for all the servers and clients
       -adds users and groups into LDAP
       -sets up autosign to be *.<domain name> so kickstarted systems will get
        their puppet cert autosigned.
   2) Scripts are run that edit the site.pp file to create some hostgroups
      and edit the hiera files to include kickstart and tftpboot.
   3) - I have copied over some manifests like workstation.pp and nfs.pp but they have not
       been tested and are not configured at this time.
- it then runs puppet once more

The post-processor then exports the virtualbox to a vagrant box and removes the
output directory.
  I have it including some certificates that were genrated on tasty.bacon.
  These were meant to be used by VRDP.  How ever, I am not sure exactly how to use these
  and have copied them out via tastypuppet to all the blades.  They are need because
  vrdp by default encrypts communication with an MD5 cert and our workstations are
  fips and don't like that.

### Some thoughts on the vagrant file:
I did not put the Vagrant file in the vagrant box so the network settings could be seen.
I don't think vagrant is smart enough to check it a vbox hostonly network exists and create it for
the machine so you will have to check, before you vagrant up the machine that the network exists,
so you need to know what ip address the machine is using..
I think you can change the network name in the vagrant box but I still have to check that. I
may not have the modifyvm set up correctly for that at this time. (TODO)

The vagrant file does not configure the machine to use the ip address, I have that disabled.  You can turn it
on, but changing the IP Address will mess up the puppet server.  Also we set up the network using puppet
in simp config and we want to see what it does, not what vagrant does.

I also turned of the vagrant directory sharing in the VagrantFile but that was just because it wasn't working at first.
I think that is fixed now.

-The vagrant password is vagrant.

### Virtual Box management notes:

This just gives some quick steps for checking your networks and configuring them

To list your hostonly networks:

   VBoxManage list hostonlyifs

When you create a new hostonly network it creates them in order, so vboxnet0, then vboxnet1 ...etc

To create a new network:
   VBoxManage hostonlyif create
(It will tell you what network it created.)

To update the address of the network:

   VBoxManage hostonlyif ipconfig <networkname>  --ip <network address>

So to make vboxnet1 set to 192.168.101.1 (that being the router address.)
   VBoxManage hostonlyif ipconfig vboxnet1 --ip 192.168.101.1

### TODO
I am sure there is much more but ...

Tests to add:
- test if master is yum that yum is set up and working.
- check if puppet is actually running on the port you specified. (netstat or ss)
- add one last puppet run in at the end and check that it returns 0 (dns and all that should
  be set up and nothing chould change at that point.)
Features to add:
- add an Environment variable in to allow it to create the box even if tests fails.
- Kickstart a server and client to go with the box.
- The distribution iso is assumed to be in /net/ISO/Distribution__ISOs.  Make that configurable.
- validate input from packer.yaml and don't fail if it does not exist because you can run with
  all the defaults.
Clean it up:
- Move the Vagrant file into the Output directory.
- Change the packer.yaml settings to match the names used in the simp.json file to make
  things more consistent
- Merge the simp_config.rb and simp_packer_tests.sh into one ruby script and clean it up.
- Delete the Virtualbox Hostonly network if we created it???

